<?php

namespace App\Repositories;

use App\Repositories\Interfaces\PersonalAccessTokenRepositoryInterface;
use Laravel\Sanctum\PersonalAccessToken;
use App\Models\User;
use Carbon\Carbon;
use Illuminate\Support\Facades\DB;

class PersonalAccessTokenRepostory implements PersonalAccessTokenRepositoryInterface 
{
    
    public function getToken(string $plainToken) 
    {
        return PersonalAccessToken::findToken($plainToken);
    }

    public function issueToken (User $user){
        if ($user->tokens()){
            $user->tokens()->delete();
        }
        return $user->createToken('token')->plainTextToken;
    }

    public function checkToken(string $requestToken): bool
    {
        return (
            $this->getToken($requestToken) && //does it exist
            ($this->getToken($requestToken)->created_at)->addMinutes(config('sanctum.expiration'))->gte(Carbon::now()) //has it expired
        );
    }

    public function refreshToken(string $sactumToken){
        DB::table('personal_access_tokens')->where('id', PersonalAccessToken::findToken($sactumToken)->id)->update(['created_at' => now()]);
    }
}